name: Index x402 Bazaar

on:
  schedule:
    # Run daily at 6am UTC
    - cron: '0 6 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

# Pin to verified x402 commit for security
# Update this periodically after reviewing changes
env:
  X402_COMMIT: 226737c6fdb77fbfaf65b9c7d1b6bdc4c19085dd

jobs:
  index:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        # Pinned to v4.2.2 (2024-10-23)
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          path: indexer

      - name: Checkout x402 repo (pinned commit)
        # Pinned to v4.2.2 (2024-10-23)
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          repository: coinbase/x402
          ref: ${{ env.X402_COMMIT }}
          path: x402
          sparse-checkout: |
            typescript/site/app/ecosystem/partners-data

      - name: Verify x402 commit
        run: |
          cd x402
          ACTUAL=$(git rev-parse HEAD)
          if [ "$ACTUAL" != "$X402_COMMIT" ]; then
            echo "ERROR: x402 commit mismatch!"
            echo "Expected: $X402_COMMIT"
            echo "Got: $ACTUAL"
            exit 1
          fi
          echo "âœ“ x402 commit verified: $ACTUAL"

      - name: Setup Node.js
        # Pinned to v4.1.0 (2024-10-24)
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: indexer/package-lock.json

      - name: Install dependencies
        working-directory: indexer
        run: npm ci

      - name: Build
        working-directory: indexer
        run: npm run build

      - name: Run indexer
        working-directory: indexer
        run: |
          npm start -- \
            --partners-data ../x402/typescript/site/app/ecosystem/partners-data \
            --output ./data/x402-index.json \
            --pretty

      - name: Generate integrity hash
        working-directory: indexer
        run: |
          # Generate SHA256 hash for integrity verification
          SHA256=$(sha256sum data/x402-index.json | cut -d' ' -f1)
          echo "SHA256: $SHA256"

          # Write hash file
          cat > data/x402-index.sha256 << EOF
          # x402 Bazaar Index Integrity Hash
          # Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          # Source commit: $X402_COMMIT

          $SHA256  x402-index.json
          EOF

          echo "âœ“ Integrity hash generated"

      - name: Commit results
        working-directory: indexer
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          mkdir -p data
          git add data/x402-index.json data/x402-index.sha256

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            SHA256=$(sha256sum data/x402-index.json | cut -d' ' -f1)
            git commit -m "chore: update index $(date -u +%Y-%m-%d)

            Indexed $(jq '.summary.totalResources' data/x402-index.json) resources
            Alive: $(jq '.summary.aliveCount' data/x402-index.json)
            Dead: $(jq '.summary.deadCount' data/x402-index.json)

            Source: coinbase/x402@${X402_COMMIT:0:7}
            SHA256: ${SHA256:0:16}..."
            git push
          fi
